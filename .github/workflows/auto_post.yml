name: Auto Blog Post - K Column Scheduler

on:
  schedule:
    # 15åˆ†ã”ã¨ã«Kåˆ—äºˆç´„æŠ•ç¨¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šç´°ã‹ã„åˆ¶å¾¡ï¼‰
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      window_minutes:
        description: 'å®Ÿè¡Œã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆåˆ†ï¼‰'
        required: false
        default: '20'
        type: string
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: false
        type: boolean
      project_filter:
        description: 'å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆç©ºæ¬„=å…¨ã¦ï¼‰'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - 'biggift'
          - 'arigataya'

jobs:
  check_scheduled_posts:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # requirements.txtãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            pip install requests gspread oauth2client
          fi
      
      - name: Validate environment variables
        run: |
          echo "ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ä¸­..."
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "âŒ GOOGLE_APPLICATION_CREDENTIALS_JSON ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          if [ -z "$SPREADSHEET_ID" ]; then
            echo "âŒ SPREADSHEET_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… å¿…é ˆç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯å®Œäº†"
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      
      - name: Run K column scheduled posts checker
        id: executor
        env:
          # Google Sheetsèªè¨¼
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          
          # Gemini APIï¼ˆè¤‡æ•°ã‚­ãƒ¼å¯¾å¿œï¼‰
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          
          # Seesaaè¨­å®š
          SEESAA_USERNAME: ${{ secrets.SEESAA_USERNAME }}
          SEESAA_PASSWORD: ${{ secrets.SEESAA_PASSWORD }}
          SEESAA_BLOGID: ${{ secrets.SEESAA_BLOGID }}
          
          # FC2è¨­å®š
          FC2_BLOG_ID: ${{ secrets.FC2_BLOG_ID }}
          FC2_USERNAME: ${{ secrets.FC2_USERNAME }}
          FC2_PASSWORD: ${{ secrets.FC2_PASSWORD }}
          
          # livedoorè¨­å®š
          LIVEDOOR_BLOG_NAME: ${{ secrets.LIVEDOOR_BLOG_NAME }}
          LIVEDOOR_ID: ${{ secrets.LIVEDOOR_ID }}
          LIVEDOOR_API_KEY: ${{ secrets.LIVEDOOR_API_KEY }}
          
          # Bloggerè¨­å®š
          BLOGGER_BLOG_ID: ${{ secrets.BLOGGER_BLOG_ID }}
          
          # æŠ•ç¨¿é–“éš”è¨­å®šï¼ˆã‚¹ãƒ‘ãƒ å›žé¿ï¼‰
          POST_MIN_INTERVAL: '60'
          POST_MAX_INTERVAL: '120'
          
        run: |
          WINDOW_MINUTES="${{ github.event.inputs.window_minutes || '20' }}"
          TEST_MODE="${{ github.event.inputs.test_mode || 'false' }}"
          PROJECT_FILTER="${{ github.event.inputs.project_filter || '' }}"
          
          echo "ðŸš€ å®Ÿè¡Œé–‹å§‹: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ“Š è¨­å®š:"
          echo "  - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: ${WINDOW_MINUTES}åˆ†"
          echo "  - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${TEST_MODE}"
          echo "  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: ${PROJECT_FILTER:-'å…¨ã¦'}"
          
          # å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰æ§‹ç¯‰
          CMD="python scripts/post_executor.py --window $WINDOW_MINUTES"
          
          if [ "$TEST_MODE" = "true" ]; then
            CMD="$CMD --test"
            echo "ðŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
          else
            echo "âš¡ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
          fi
          
          if [ -n "$PROJECT_FILTER" ]; then
            CMD="$CMD --project $PROJECT_FILTER"
          fi
          
          # å®Ÿè¡Œ
          eval $CMD
          
          # çµæžœã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          echo "EXECUTION_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
      
      - name: Create execution summary
        if: always()
        run: |
          echo "## ðŸ“‹ Kåˆ—äºˆç´„æŠ•ç¨¿å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åŸºæœ¬æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ™‚åˆ»**: ${EXECUTION_TIME:-$(date '+%Y-%m-%d %H:%M:%S')}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¦ã‚£ãƒ³ãƒ‰ã‚¦**: ${{ github.event.inputs.window_minutes || '20' }}åˆ†" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ${{ github.event.inputs.project_filter || 'å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¯¾è±¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ " >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ“ãƒƒã‚¯ã‚®ãƒ•ãƒˆå‘ã‘**: Blogger, livedoor" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚ã‚ŠãŒãŸå±‹å‘ã‘**: Seesaa, FC2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æˆåŠŸ** - Kåˆ—äºˆç´„æŠ•ç¨¿ãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **å¤±æ•—** - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Kåˆ—äºˆç´„æŠ•ç¨¿ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯Actionså®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          # Slackã‚„ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã“ã“ã«
      
      - name: Clean up temporary files
        if: always()
        run: |
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          find /tmp -name "*.json" -mmin +60 -delete 2>/dev/null || true
          echo "ðŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
